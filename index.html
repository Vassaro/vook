<!DOCTYPE html>
<html lang="en">

<head>
    <title>Startkort</title>
    <link rel="icon" type="image/x-icon" href="img/hollyrosa-square.png">
    <meta charset="utf-8" />

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/simplestorage.js@0.2.1/simpleStorage.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>
        Orienteringsleder
    </h1>

    <button id="flushButton" style="margin-top: 20px; background-color: darkred; color: white; padding: 10px;">
        Radera alla registreringar
    </button>

    <h2>
        Mina leder
    </h2>

    <button id="startNewCourse">Starta ny led</button>
    <div id="newCourse">
        <p>Välj en led:</p>
        <div id="availableCourses"></div>
    </div>

    <div id="startedCourses"></div>

    <script>
        const storage = simpleStorage;

        function getStartedCourses() {
            return storage.get("startedCourses") || [];
        };

        function saveStartedCourses(courses) {
            storage.set("startedCourses", courses);
        }

        function showStartedCourses() {
            const courses = getStartedCourses();
            const container = document.getElementById("startedCourses");
            container.innerHTML = "";
            if (courses.length === 0) {
                container.innerHTML = "<p><i>Du har inga pågående leder.</i></p>"
            } else {
                courses.forEach(course => {
                    const button = document.createElement("button");
                    button.textContent = course.name;
                    button.onclick = () => window.location.href = `controlcard.html?id=${course.id}`;
                    container.appendChild(button);
                });
            }
        };

        function compareNumbers(a, b) {
            return a - b;
        }

        function getAllCourses() {
            const newCourseDiv = document.getElementById("newCourse");
            newCourseDiv.style.display = newCourseDiv.style.display === "none" ? "block" : "none";
            if (newCourseDiv.style.display === "none") return;

            fetch("data/courses.json")
                .then(res => res.json())
                .then(allCourses => {
                    const availableCoursesDiv = document.getElementById("availableCourses");
                    availableCoursesDiv.innerHTML = "";

                    const startedCourses = getStartedCourses();
                    const startedIds = startedCourses.map(course => course.id);
                    console.log(allCourses.sort(compareNumbers))
                    allCourses.sort(compareNumbers).forEach(course => {
                        if (!startedIds.includes(course.id)) {
                            const div = document.createElement("div");
                            div.className = "course";
                            div.textContent = course.name + ", " + course.desc;
                            div.onclick = () => startCourse(course);
                            availableCoursesDiv.appendChild(div);
                        }
                    });

                    if (availableCoursesDiv.innerHTML === "") {
                        availableCoursesDiv.innerHTML = "<p>Inga fler leder att starta.</p>";
                    }
                });
        }


        function startCourse(course) {
            const startedCourses = getStartedCourses();
            startedCourses.push({ id: course.id, name: course.name });
            saveStartedCourses(startedCourses);
            document.getElementById("newCourse").style.display = "none";
            window.location.href = `controlcard.html?id=${course.id}`;
        }





        document.getElementById("startNewCourse").addEventListener("click", getAllCourses);

        document.getElementById("flushButton").addEventListener("click", function () {
            storage.flush();
            showStartedCourses();
            document.getElementById("availableCourses").innerHTML = "";
        });

        showStartedCourses();
    </script>
</body>

</html>