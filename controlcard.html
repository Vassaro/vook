<!DOCTYPE html>
<html lang="en">

<head>
    <title>Startkort</title>
    <link rel="icon" type="image/x-icon" href="img/hollyrosa-square.png">
    <meta charset="utf-8" />

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/simplestorage.js@0.2.1/simpleStorage.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Startkort</h1>
    <h2 id="nameOfCourse"></h2>
    <h2>Registrera kontroller</h2>
    <form id="form" method="post">
        <label for="number">Kontrollnummer:</label><br>
        <input type="number" id="number" placeholder="Kontrollens nummer" required autocomplete="off"><br><br>
        <label for="code">Kod:</label><br>
        <input type="text" id="code" placeholder="Koden p√• kontrollen" required autocomplete="off"><br><br>
        <button type="submit">Skicka in</button>
    </form>

    <h2>Kontroller</h2>

    <p>
        ‚úÖ R√§tt: <span id="correctCount">0</span>
        ‚ùå Fel: <span id="incorrectCount">0</span>
        üïµÔ∏è Ej hittade: <span id="notFoundCount">?</span>
    </p>

    <div id="grid"></div>

    <script>

        const storage = simpleStorage;
        console.log(storage);

        const courseID = getCourseID();
        console.log(courseID);

        function loadCourse(courseID) {
            return storage.get(courseID) || [];
        };

        function saveCourse(courseID, course) {
            storage.set(courseID, course)
        };

        function getCourseID() {
            const params = new URLSearchParams(window.location.search);
            return params.get("id");
        }

        async function getCourse(courseID) {
            const response = await fetch("data/courses.json");
            const allCourses = await response.json();
            return allCourses.find(course => course.id === courseID);
        }

        async function init() {
            const course = await getCourse(courseID);
            if (!course) {
                document.body.innerHTML = "<h1>Kursen hittades inte!</h1>";
                return;
            }

            console.log(course)
            if (course.numericalorder) {
                course.controlpoints.sort();
            }

            const courseProgress = loadCourse(courseID)
            console.log(courseProgress)

            const form = document.getElementById("form");
            const grid = document.getElementById("grid");

            form.addEventListener("submit", (e) => {
                e.preventDefault();
                const number = parseInt(document.getElementById("number").value.trim());
                const code = document.getElementById("code").value.trim();

                // Uppdatera progress
                courseProgress = courseProgress.filter(entry => entry.number !== number);
                courseProgress.push({ number, code });

                saveCourseProgress(courseID, courseProgress);
                renderGrid(course, courseProgress);
                form.reset();
            });

            function renderGrid(course, progress) {
                grid.innerHTML = "";

                let correct = 0;
                let incorrect = 0;

                course.controlpoints.forEach(([number, code]) => {
                    const cell = document.createElement("div");
                    cell.className = "box";
                    cell.textContent = number;

                    const found = courseProgress.find(entry => entry.number == number);
                    if (found) {
                        if (found.code.toLowerCase() === code.toLowerCase()) {
                            cell.classList.add("green");
                            correct++;
                        } else {
                            cell.classList.add("red");
                            incorrect++;
                        }
                    } else {
                        cell.classList.add("gray");
                    }

                    grid.appendChild(cell);
                });

                document.getElementById("nameOfCourse").textContent = course.name
                document.getElementById("correctCount").textContent = correct;
                document.getElementById("incorrectCount").textContent = incorrect;
                document.getElementById("notFoundCount").textContent = course.controlpoints.length - correct - incorrect;
            };

            renderGrid(course, courseProgress);
        }

        init();




    </script>
</body>

</html>